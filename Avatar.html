<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Avatar Builder Preview</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#111a33; --panel2:#0f1730; --text:#e8eeff; --muted:#a9b4df;
      --stroke:rgba(255,255,255,.08);
      --accent:#7c5cff;
      --good:#20d48a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1000px 600px at 10% 10%, rgba(124,92,255,.22), transparent 55%),
                  radial-gradient(900px 600px at 90% 20%, rgba(32,212,138,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:20px 18px 8px; max-width:1100px; margin:0 auto;
    }
    h1{margin:0 0 6px; font-size:22px; font-weight:750; letter-spacing:.2px}
    p{margin:0; color:var(--muted); line-height:1.35}

    .wrap{max-width:1100px; margin:0 auto; padding:14px 18px 30px; display:grid; gap:14px; grid-template-columns: 420px 1fr;}
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr;} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      border-radius:16px;
      box-shadow: 0 20px 70px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px; display:flex; align-items:center; justify-content:space-between;
      background: rgba(0,0,0,.12);
      border-bottom:1px solid var(--stroke);
    }
    .hd .title{font-weight:700; letter-spacing:.2px}

    .preview{
      display:grid; grid-template-columns: 1fr; align-items:center;
      padding:18px;
      min-height:520px;
      background: radial-gradient(500px 420px at 50% 45%, rgba(124,92,255,.18), transparent 62%),
                  radial-gradient(520px 420px at 55% 55%, rgba(32,212,138,.10), transparent 62%),
                  linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
    }

    .avatarFrame{
      width:360px; max-width:100%; aspect-ratio: 1 / 1;
      margin:0 auto;
      border-radius:18px;
      background: rgba(10,14,28,.65);
      border:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }

    .shadowBadge{
      position:absolute; bottom:12px; left:12px;
      padding:8px 10px; border-radius:999px;
      background: rgba(0,0,0,.28);
      border:1px solid var(--stroke);
      color:var(--muted);
      font-size:12px;
      display:flex; gap:8px; align-items:center;
      user-select:none;
    }
    .dot{width:8px; height:8px; border-radius:999px; background: var(--good); box-shadow:0 0 0 3px rgba(32,212,138,.12)}

    /* Controls */
    .controls{padding:14px; display:grid; gap:12px; background: rgba(0,0,0,.06)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 980px){ .row{grid-template-columns:1fr;} }

    .field{
      background: rgba(17,26,51,.55);
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:10px 10px 12px;
    }
    .label{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;}
    .label span{font-size:12px; color:var(--muted)}

    select, input[type="color"], button, input[type="range"]{
      width:100%;
      height:38px;
      border-radius:10px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.25);
      color: var(--text);
      outline:none;
      padding:0 10px;
      font-size:14px;
    }
    input[type="color"]{padding:0; height:40px; cursor:pointer}

    input[type="range"]{height:38px; padding:0 10px}

    button{
      cursor:pointer;
      font-weight:700;
      letter-spacing:.2px;
      background: linear-gradient(180deg, rgba(124,92,255,.95), rgba(124,92,255,.75));
      border:1px solid rgba(124,92,255,.35);
      box-shadow: 0 10px 30px rgba(124,92,255,.20);
    }
    button.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      box-shadow:none;
      font-weight:650;
    }
    button:active{transform: translateY(1px)}

    .btnRow{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
    @media (max-width: 520px){ .btnRow{grid-template-columns:1fr;} }

    .small{font-size:12px; color:var(--muted); line-height:1.35}

    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      background: rgba(0,0,0,.25);
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:10px;
      overflow:auto;
      max-height:160px;
      white-space:pre;
    }

    /* SVG crispness */
    svg{max-width: 92%; height:auto}
  </style>
</head>
<body>
  <header>
    <h1>Customizable Avatar Builder (Drop-in Preview)</h1>
    <p>Adjust parts + colors, randomize, and export a PNG. The JSON block is what you’d save in your game for each player.</p>
  </header>

  <main class="wrap">
    <section class="card" aria-label="Avatar preview">
      <div class="hd">
        <div class="title">Preview</div>
        <div style="display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px">
          <span id="seedLabel">Seed: —</span>
        </div>
      </div>
      <div class="preview">
        <div class="avatarFrame">
          <div id="svgMount" aria-label="Avatar SVG" role="img"></div>
          <div class="shadowBadge"><span class="dot"></span><span>Live preview</span></div>
        </div>

        <div style="margin:14px auto 0; width:min(360px, 100%)">
          <div class="field">
            <div class="label"><strong style="font-size:13px">Avatar JSON</strong><span>Copy/save</span></div>
            <div id="jsonOut" class="code"></div>
          </div>
          <p class="small" style="margin:10px 4px 0">Tip: in your game, store this JSON per player and rebuild the avatar at runtime.</p>
        </div>
      </div>
    </section>

    <section class="card" aria-label="Avatar controls">
      <div class="hd"><div class="title">Customize</div><div style="color:var(--muted); font-size:12px">No libraries • SVG layers</div></div>
      <div class="controls">
        <div class="row">
          <div class="field">
            <div class="label"><strong>Body</strong><span>shape</span></div>
            <select id="bodyShape">
              <option value="round">Round</option>
              <option value="square">Square</option>
              <option value="bean">Bean</option>
            </select>
          </div>
          <div class="field">
            <div class="label"><strong>Skin</strong><span>color</span></div>
            <input id="skin" type="color" value="#F2C7A5" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <div class="label"><strong>Hair</strong><span>style</span></div>
            <select id="hairStyle">
              <option value="short">Short</option>
              <option value="puff">Puff</option>
              <option value="long">Long</option>
              <option value="none">None</option>
            </select>
          </div>
          <div class="field">
            <div class="label"><strong>Hair</strong><span>color</span></div>
            <input id="hair" type="color" value="#2C1E1A" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <div class="label"><strong>Eyes</strong><span>style</span></div>
            <select id="eyeStyle">
              <option value="dots">Dots</option>
              <option value="happy">Happy</option>
              <option value="sleepy">Sleepy</option>
            </select>
          </div>
          <div class="field">
            <div class="label"><strong>Eye color</strong><span>iris</span></div>
            <input id="eye" type="color" value="#1A2433" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <div class="label"><strong>Mouth</strong><span>expression</span></div>
            <select id="mouthStyle">
              <option value="smile">Smile</option>
              <option value="neutral">Neutral</option>
              <option value="open">Open</option>
            </select>
          </div>
          <div class="field">
            <div class="label"><strong>Accessory</strong><span>extra</span></div>
            <select id="accessory">
              <option value="none">None</option>
              <option value="glasses">Glasses</option>
              <option value="earring">Earring</option>
              <option value="cap">Cap</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <div class="label"><strong>Outfit</strong><span>style</span></div>
            <select id="outfit">
              <option value="hoodie">Hoodie</option>
              <option value="tee">Tee</option>
              <option value="armor">Armor</option>
            </select>
          </div>
          <div class="field">
            <div class="label"><strong>Outfit color</strong><span>primary</span></div>
            <input id="outfitColor" type="color" value="#7C5CFF" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <div class="label"><strong>Background</strong><span>card</span></div>
            <select id="bg">
              <option value="nebula">Nebula</option>
              <option value="sunset">Sunset</option>
              <option value="mint">Mint</option>
              <option value="none">None</option>
            </select>
          </div>
          <div class="field">
            <div class="label"><strong>Head tilt</strong><span>fun</span></div>
            <input id="tilt" type="range" min="-10" max="10" step="1" value="0" />
          </div>
        </div>

        <div class="btnRow">
          <button id="randomBtn" type="button">Randomize</button>
          <button id="exportBtn" type="button" class="secondary">Export PNG</button>
          <button id="copyBtn" type="button" class="secondary">Copy JSON</button>
        </div>

        <div class="row">
          <div class="field">
            <div class="label"><strong>Display name</strong><span>nameplate</span></div>
            <input id="displayName" type="text" value="Player" maxlength="18" style="height:38px" />
          </div>
          <div class="field">
            <div class="label"><strong>Badge</strong><span>rarity</span></div>
            <select id="badge">
              <option value="common">Common</option>
              <option value="rare">Rare</option>
              <option value="epic">Epic</option>
            </select>
          </div>
        </div>

        <div class="field">
          <div class="label"><strong>How to integrate</strong><span>quick notes</span></div>
          <div class="small">
            <ul style="margin:0; padding-left:18px">
              <li>Store the JSON per player (or a seed + choices).</li>
              <li>On load, rebuild the SVG layers using the same keys.</li>
              <li>For multiplayer, send only JSON (tiny) rather than textures.</li>
              <li>To add more parts, duplicate a layer block in <span style="color:var(--text)">renderAvatarSVG()</span>.</li>
            </ul>
          </div>
        </div>

      </div>
    </section>
  </main>

  <script>
    // -----------------------------
    // Avatar model (v2)
    // Improvements applied: (1) rarity + weighted randomize, (3) nameplate + emotes,
    // (5) modular layers, (7) lighting/depth, (8) animation (blink/breathe/hover)
    // -----------------------------
    const state = {
      seed: 12012026,
      // identity
      displayName: 'Player',
      badge: 'common', // common | rare | epic

      // choices
      bodyShape: 'round',
      skin: '#F2C7A5',
      hairStyle: 'short',
      hair: '#2C1E1A',
      eyeStyle: 'dots',
      eye: '#1A2433',
      mouthStyle: 'smile',
      accessory: 'none',
      outfit: 'hoodie',
      outfitColor: '#7C5CFF',
      bg: 'nebula',
      tilt: 0,

      // animation toggles (kept internal for now)
      animate: true,
    };

    // -----------------------------
    // RNG + weighted picks (rarity)
    // -----------------------------
    // Mulberry32: deterministic, fast, tiny
    function mulberry32(a){
      return function(){
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      }
    }

    function pick(rng, arr){ return arr[Math.floor(rng()*arr.length)] }

    // weights: [{v:'x', w:10}, ...]
    function weightedPick(rng, weighted){
      let total = 0;
      for(const it of weighted) total += it.w;
      let r = rng() * total;
      for(const it of weighted){
        r -= it.w;
        if(r <= 0) return it.v;
      }
      return weighted[weighted.length - 1].v;
    }

    const palette = {
      skins: ['#F7D4B5','#F2C7A5','#E9B894','#DDA57E','#C98F6B','#B97B58','#A86949','#8E553D'],
      hairs: ['#2C1E1A','#3A2B22','#1A1A1A','#6B4B3A','#B8865B','#D7C29B'],
      outfits: ['#7C5CFF','#20D48A','#FF5C86','#FFD166','#4DD0FF','#B3FF75'],
      eyes: ['#1A2433','#0B1020','#2C3E50','#2D1E55','#1F3B33']
    };

    const parts = {
      bodyShape: ['round','square','bean'],
      hairStyle: ['short','puff','long','none'],
      eyeStyle: ['dots','happy','sleepy'],
      mouthStyle: ['smile','neutral','open'],
      outfit: ['hoodie','tee','armor'],
      bg: ['nebula','sunset','mint','none'],
    };

    // Rarity rules: tweak as you like
    // - accessory is where we put most of the rarity feel
    // - badge is derived from chosen rarity tier
    const rarityTiers = {
      common: {
        badge: 'common',
        accessory: [
          {v:'none', w:60},
          {v:'glasses', w:30},
          {v:'earring', w:10},
          {v:'cap', w:4},
        ]
      },
      rare: {
        badge: 'rare',
        accessory: [
          {v:'none', w:30},
          {v:'glasses', w:35},
          {v:'earring', w:18},
          {v:'cap', w:16},
        ]
      },
      epic: {
        badge: 'epic',
        accessory: [
          {v:'none', w:18},
          {v:'glasses', w:30},
          {v:'earring', w:22},
          {v:'cap', w:26},
        ]
      }
    };

    function randomize(){
      const seed = Math.floor(Math.random()*1e9);
      const rng = mulberry32(seed);

      // Pick tier (you can also lock this behind progression)
      const tier = weightedPick(rng, [
        {v:'common', w:72},
        {v:'rare', w:22},
        {v:'epic', w:6},
      ]);

      state.seed = seed;
      state.badge = tier;

      state.bodyShape = pick(rng, parts.bodyShape);
      state.hairStyle = pick(rng, parts.hairStyle);
      state.eyeStyle = pick(rng, parts.eyeStyle);
      state.mouthStyle = pick(rng, parts.mouthStyle);
      state.outfit = pick(rng, parts.outfit);
      state.bg = pick(rng, parts.bg);

      state.accessory = weightedPick(rng, rarityTiers[tier].accessory);

      state.skin = pick(rng, palette.skins);
      state.hair = pick(rng, palette.hairs);
      state.outfitColor = pick(rng, palette.outfits);
      state.eye = pick(rng, palette.eyes);
      state.tilt = Math.floor(rng()*21) - 10;

      // give a simple name variation for testing
      const names = ['Player','Nova','Rune','Echo','Skye','Milo','Astra','Kai','Nyx','Pip'];
      state.displayName = pick(rng, names);

      syncInputs();
      render();
    }

    // -----------------------------
    // Modular SVG layers (5)
    // -----------------------------
    function layerBackground(model){
      const bg = model.bg;
      if(bg === 'none'){
        return `<rect x="0" y="0" width="400" height="400" fill="#0B1020"/>`;
      }
      if(bg === 'nebula'){
        return `
          <defs>
            <radialGradient id="g1" cx="35%" cy="30%" r="70%">
              <stop offset="0" stop-color="#7C5CFF" stop-opacity="0.55"/>
              <stop offset="0.55" stop-color="#1C2A63" stop-opacity="0.15"/>
              <stop offset="1" stop-color="#0B1020" stop-opacity="0"/>
            </radialGradient>
            <radialGradient id="g2" cx="70%" cy="65%" r="75%">
              <stop offset="0" stop-color="#20D48A" stop-opacity="0.35"/>
              <stop offset="0.6" stop-color="#0F1730" stop-opacity="0.12"/>
              <stop offset="1" stop-color="#0B1020" stop-opacity="0"/>
            </radialGradient>
          </defs>
          <rect x="0" y="0" width="400" height="400" fill="#0B1020"/>
          <rect x="0" y="0" width="400" height="400" fill="url(#g1)"/>
          <rect x="0" y="0" width="400" height="400" fill="url(#g2)"/>
          <g opacity="0.18">
            <circle cx="70" cy="90" r="4" fill="#fff"/>
            <circle cx="305" cy="70" r="3" fill="#fff"/>
            <circle cx="250" cy="310" r="4" fill="#fff"/>
            <circle cx="120" cy="290" r="2.8" fill="#fff"/>
          </g>
        `;
      }
      if(bg === 'sunset'){
        return `
          <defs>
            <linearGradient id="sun" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#FF5C86" stop-opacity="0.55"/>
              <stop offset="0.45" stop-color="#FFD166" stop-opacity="0.38"/>
              <stop offset="1" stop-color="#4DD0FF" stop-opacity="0.12"/>
            </linearGradient>
          </defs>
          <rect x="0" y="0" width="400" height="400" fill="#0B1020"/>
          <rect x="0" y="0" width="400" height="400" fill="url(#sun)"/>
          <g opacity="0.12">
            <path d="M0,280 C80,250 130,320 210,290 C290,260 320,330 400,300 L400,400 L0,400 Z" fill="#000"/>
          </g>
        `;
      }
      // mint
      return `
        <defs>
          <radialGradient id="m1" cx="50%" cy="35%" r="75%">
            <stop offset="0" stop-color="#20D48A" stop-opacity="0.40"/>
            <stop offset="0.55" stop-color="#4DD0FF" stop-opacity="0.18"/>
            <stop offset="1" stop-color="#0B1020" stop-opacity="0"/>
          </radialGradient>
        </defs>
        <rect x="0" y="0" width="400" height="400" fill="#0B1020"/>
        <rect x="0" y="0" width="400" height="400" fill="url(#m1)"/>
        <g opacity="0.14">
          <circle cx="85" cy="105" r="26" fill="#fff"/>
          <circle cx="325" cy="305" r="18" fill="#fff"/>
        </g>
      `;
    }

    function bodyPath(shape){
      if(shape === 'square') return `<rect x="110" y="95" rx="54" ry="54" width="180" height="200" />`;
      if(shape === 'bean'){
        return `<path d="M135 110 C155 85 205 78 232 98 C260 118 285 140 278 175 C272 210 294 232 274 258 C254 284 215 302 182 292 C150 282 120 258 118 225 C116 192 115 135 135 110 Z" />`;
      }
      return `<path d="M200 92 c70 0 105 58 105 128 c0 70 -35 118 -105 118 c-70 0 -105 -48 -105 -118 c0 -70 35 -128 105 -128 z" />`;
    }

    function layerOutfit(model){
      const color = model.outfitColor;
      const type = model.outfit;

      // Base silhouettes (kept compatible with old shapes)
      let base = '';
      let foldHi = '';
      let foldLo = '';
      if(type === 'tee'){
        base = `
          <path id="outfitSil" d="M120 292 C145 270 170 260 200 260 C230 260 255 270 280 292 L270 340 C250 358 230 366 200 366 C170 366 150 358 130 340 Z" />
        `;
        foldHi = `<path d="M152 292 Q200 318 248 292" fill="none" stroke="rgba(255,255,255,.18)" stroke-width="10" stroke-linecap="round"/>`;
        foldLo = `<path d="M150 334 Q200 356 250 334" fill="none" stroke="rgba(0,0,0,.20)" stroke-width="12" stroke-linecap="round"/>`;
      } else if(type === 'armor'){
        base = `
          <path id="outfitSil" d="M128 294 C152 268 174 258 200 258 C226 258 248 268 272 294 L260 346 C236 366 220 372 200 372 C180 372 164 366 140 346 Z" />
          <path d="M150 298 L200 276 L250 298 L240 352 L200 366 L160 352 Z" fill="rgba(0,0,0,.16)"/>
          <path d="M200 276 V366" stroke="rgba(255,255,255,.10)" stroke-width="8" stroke-linecap="round"/>
          <circle cx="170" cy="312" r="6" fill="rgba(255,255,255,.22)"/>
          <circle cx="230" cy="312" r="6" fill="rgba(255,255,255,.22)"/>
        `;
        foldHi = `<path d="M150 306 Q200 330 250 306" fill="none" stroke="rgba(255,255,255,.16)" stroke-width="10" stroke-linecap="round"/>`;
        foldLo = `<path d="M155 342 Q200 362 245 342" fill="none" stroke="rgba(0,0,0,.22)" stroke-width="12" stroke-linecap="round"/>`;
      } else {
        // hoodie
        base = `
          <path id="outfitSil" d="M120 294 C140 266 165 252 200 252 C235 252 260 266 280 294 L270 346 C248 366 226 374 200 374 C174 374 152 366 130 346 Z" />
          <path d="M150 296 C160 274 175 262 200 262 C225 262 240 274 250 296" fill="none" stroke="rgba(0,0,0,.18)" stroke-width="10" stroke-linecap="round"/>
          <path d="M185 298 V340" stroke="rgba(255,255,255,.10)" stroke-width="8" stroke-linecap="round"/>
          <path d="M215 298 V340" stroke="rgba(255,255,255,.10)" stroke-width="8" stroke-linecap="round"/>
        `;
        foldHi = `<path d="M150 308 Q200 334 250 308" fill="none" stroke="rgba(255,255,255,.16)" stroke-width="10" stroke-linecap="round"/>`;
        foldLo = `<path d="M150 346 Q200 368 250 346" fill="none" stroke="rgba(0,0,0,.20)" stroke-width="12" stroke-linecap="round"/>`;
      }

      // Material shading: fabric highlight + ambient occlusion under head
      // The gradient is injected via global defs in renderAvatarSVG.
      return `
        <g aria-label="Outfit">
          <g fill="${color}" opacity="0.98">${base}</g>
          <g clip-path="url(#outfitClip)">
            <rect x="80" y="220" width="260" height="200" fill="url(#clothLight)" opacity="0.70"/>
            <rect x="80" y="220" width="260" height="200" fill="url(#clothShade)" opacity="0.42"/>
          </g>
          <ellipse cx="200" cy="255" rx="66" ry="18" fill="rgba(0,0,0,.22)" opacity="0.65"/>
          ${foldHi}
          ${foldLo}
          <path d="M130 306 C150 288 170 278 200 278 C230 278 250 288 270 306" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="8" stroke-linecap="round"/>
        </g>
      `;
    }

    function layerBody(model){
      // (7) Bigger lighting: subsurface-like warm highlight, cool shadow, rim light, inner AO.
      const shape = model.bodyShape;
      const sil = bodyPath(shape);

      return `
        <g aria-label="Body" filter="url(#softShadow)">
          <defs>
            <clipPath id="bodyClip">${sil}</clipPath>
          </defs>

          <!-- Base skin -->
          <g fill="${model.skin}" stroke="rgba(0,0,0,.18)" stroke-width="2">${sil}</g>

          <!-- Large light & shade -->
          <g clip-path="url(#bodyClip)">
            <rect x="70" y="60" width="260" height="260" fill="url(#skinLight)" opacity="0.90"/>
            <rect x="70" y="60" width="260" height="260" fill="url(#skinShade)" opacity="0.60"/>
            <!-- subtle subsurface warm bloom -->
            <circle cx="190" cy="210" r="86" fill="rgba(255,170,140,.16)"/>
            <!-- ambient occlusion under hairline -->
            <ellipse cx="200" cy="170" rx="86" ry="20" fill="rgba(0,0,0,.18)" opacity="0.75"/>
          </g>

          <!-- Rim light (pops off backgrounds) -->
          <g opacity="0.85">
            <g fill="none" stroke="url(#rimStroke)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round">${sil}</g>
          </g>

          <!-- Micro highlights -->
          <path d="M152 210 C152 162 175 132 205 132" fill="none" stroke="rgba(255,255,255,.16)" stroke-width="10" stroke-linecap="round"/>
          <path d="M246 122 C274 146 286 176 286 206" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="10" stroke-linecap="round"/>
        </g>
      `;
    }

    function layerHair(model){
      // (7) Material: hair sheen + deeper shadow at roots.
      const style = model.hairStyle;
      const hair = model.hair;
      if(style === 'none') return '';

      let hairSil = '';
      let detail = '';
      if(style === 'short'){
        hairSil = `<path id="hairSil" d="M115 165 C125 110 165 90 200 92 C250 95 285 125 290 165 C280 145 265 130 240 122 C220 115 185 118 165 128 C145 138 130 150 115 165 Z"/>`;
        detail = `<path d="M126 172 C138 140 162 124 190 120" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="8" stroke-linecap="round"/>`;
      } else if(style === 'puff'){
        hairSil = `
          <g id="hairSil" fill="none">
            <path d="M125 170 C130 130 160 110 200 110 C240 110 270 130 275 170 C262 150 245 140 220 137 C195 134 170 140 150 150 C138 156 130 162 125 170 Z"/>
          </g>
        `;
        // puff isn't one silhouette; approximate with multiple circles + a base cap
        return `
          <g aria-label="Hair">
            <g fill="${hair}" filter="url(#hairShadow)">
              <circle cx="150" cy="145" r="26"/>
              <circle cx="185" cy="128" r="30"/>
              <circle cx="220" cy="130" r="30"/>
              <circle cx="255" cy="148" r="26"/>
              <path d="M125 170 C130 130 160 110 200 110 C240 110 270 130 275 170 C262 150 245 140 220 137 C195 134 170 140 150 150 C138 156 130 162 125 170 Z" />
            </g>
            <g opacity="0.75">
              <path d="M130 166 C150 132 178 120 205 120" fill="none" stroke="rgba(255,255,255,.14)" stroke-width="10" stroke-linecap="round"/>
            </g>
          </g>
        `;
      } else {
        // long
        hairSil = `<path id="hairSil" d="M122 178 C120 130 155 92 205 92 C252 92 285 125 288 175 C290 220 276 270 268 298 C246 318 218 328 184 326 C154 322 132 308 118 288 C112 250 120 205 122 178 Z"/>`;
        detail = `<path d="M132 176 C150 136 175 120 205 120 C235 120 258 132 276 168" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="8" stroke-linecap="round"/>`;
      }

      return `
        <g aria-label="Hair">
          <defs>
            <clipPath id="hairClip">${hairSil}</clipPath>
          </defs>
          <g fill="${hair}" filter="url(#hairShadow)">${hairSil}</g>
          <!-- Root shadow -->
          <g clip-path="url(#hairClip)">
            <rect x="90" y="80" width="260" height="190" fill="url(#hairShade)" opacity="0.55"/>
          </g>
          <!-- Sheen -->
          <g clip-path="url(#hairClip)">
            <rect x="70" y="70" width="280" height="230" fill="url(#hairShine)" opacity="0.60"/>
          </g>
          ${detail}
        </g>
      `;
    }

    function layerFace(model){
      const cheeks = `
        <circle cx="150" cy="214" r="10" fill="#FF5C86" opacity="0.12"/>
        <circle cx="250" cy="214" r="10" fill="#FF5C86" opacity="0.12"/>
      `;

      return `
        ${layerEyes(model)}
        ${cheeks}
        ${layerMouth(model)}
      `;
    }

    function layerEyes(model){
      // (7) Eye upgrade: sclera tint + iris gradient + catchlight.
      // We keep the three styles, but "dots" becomes the highest quality look.
      const style = model.eyeStyle;
      const iris = model.eye;

      if(style === 'dots'){
        return `
          <g aria-label="Eyes">
            <g id="eyesOpen">
              <!-- sclera -->
              <ellipse cx="168" cy="190" rx="16" ry="12" fill="rgba(255,255,255,.85)" opacity="0.92"/>
              <ellipse cx="232" cy="190" rx="16" ry="12" fill="rgba(255,255,255,.85)" opacity="0.92"/>
              <!-- iris -->
              <g color="${iris}">
                <circle cx="168" cy="190" r="8.5" fill="url(#irisGrad)"/>
                <circle cx="232" cy="190" r="8.5" fill="url(#irisGrad)"/>
              </g>
              <!-- pupil -->
              <circle cx="168" cy="190" r="3.4" fill="#0B1020" opacity="0.95"/>
              <circle cx="232" cy="190" r="3.4" fill="#0B1020" opacity="0.95"/>
              <!-- catchlight -->
              <circle cx="164" cy="186" r="2.4" fill="rgba(255,255,255,.9)"/>
              <circle cx="228" cy="186" r="2.4" fill="rgba(255,255,255,.9)"/>
              <!-- lash line -->
              <path d="M152 184 Q168 176 184 184" fill="none" stroke="rgba(0,0,0,.35)" stroke-width="5" stroke-linecap="round"/>
              <path d="M216 184 Q232 176 248 184" fill="none" stroke="rgba(0,0,0,.35)" stroke-width="5" stroke-linecap="round"/>
            </g>
            <g id="eyesClosed" opacity="0">
              <path d="M154 190 Q168 198 182 190" fill="none" stroke="#0B1020" stroke-width="8" stroke-linecap="round"/>
              <path d="M218 190 Q232 198 246 190" fill="none" stroke="#0B1020" stroke-width="8" stroke-linecap="round"/>
            </g>
          </g>
        `;
      }

      if(style === 'happy'){
        return `
          <g aria-label="Eyes">
            <g id="eyesOpen">
              <path d="M156 188 Q168 176 180 188" fill="none" stroke="#0B1020" stroke-width="8" stroke-linecap="round"/>
              <path d="M220 188 Q232 176 244 188" fill="none" stroke="#0B1020" stroke-width="8" stroke-linecap="round"/>
              <circle cx="168" cy="193" r="3" fill="${iris}" opacity="0.55" />
              <circle cx="232" cy="193" r="3" fill="${iris}" opacity="0.55" />
              <path d="M150 182 Q168 170 186 182" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="6" stroke-linecap="round"/>
              <path d="M214 182 Q232 170 250 182" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="6" stroke-linecap="round"/>
            </g>
            <g id="eyesClosed" opacity="0">
              <path d="M156 190 Q168 200 180 190" fill="none" stroke="#0B1020" stroke-width="8" stroke-linecap="round"/>
              <path d="M220 190 Q232 200 244 190" fill="none" stroke="#0B1020" stroke-width="8" stroke-linecap="round"/>
            </g>
          </g>
        `;
      }

      // sleepy
      return `
        <g aria-label="Eyes">
          <g id="eyesOpen">
            <path d="M152 186 Q168 198 184 186" fill="none" stroke="#0B1020" stroke-width="8" stroke-linecap="round"/>
            <path d="M216 186 Q232 198 248 186" fill="none" stroke="#0B1020" stroke-width="8" stroke-linecap="round"/>
            <path d="M150 200 Q168 208 186 200" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="6" stroke-linecap="round"/>
            <path d="M214 200 Q232 208 250 200" fill="none" stroke="rgba(255,255,255,.10)" stroke-width="6" stroke-linecap="round"/>
          </g>
          <g id="eyesClosed" opacity="0">
            <path d="M152 190 Q168 200 184 190" fill="none" stroke="#0B1020" stroke-width="8" stroke-linecap="round"/>
            <path d="M216 190 Q232 200 248 190" fill="none" stroke="#0B1020" stroke-width="8" stroke-linecap="round"/>
          </g>
        </g>
      `;
    }

    function layerMouth(model){
      const style = model.mouthStyle;
      if(style === 'neutral'){
        return `<path d="M175 232 Q200 238 225 232" fill="none" stroke="#0B1020" stroke-width="8" stroke-linecap="round"/>`;
      }
      if(style === 'open'){
        return `
          <path d="M176 230 Q200 255 224 230 Q200 220 176 230 Z" fill="#0B1020" opacity="0.92"/>
          <path d="M184 234 Q200 246 216 234" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="6" stroke-linecap="round"/>
        `;
      }
      return `<path d="M170 228 Q200 260 230 228" fill="none" stroke="#0B1020" stroke-width="8" stroke-linecap="round"/>`;
    }

    function layerAccessory(model){
      const type = model.accessory;
      if(type === 'none') return '';
      if(type === 'glasses'){
        return `
          <g fill="none" stroke="#0B1020" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" opacity="0.92">
            <rect x="138" y="176" width="56" height="34" rx="14"/>
            <rect x="206" y="176" width="56" height="34" rx="14"/>
            <path d="M194 193 H206" />
            <path d="M138 193 C120 190 118 186 110 182" />
            <path d="M262 193 C280 190 282 186 290 182" />
          </g>
        `;
      }
      if(type === 'earring'){
        return `
          <g fill="none" stroke="#FFD166" stroke-width="7" stroke-linecap="round" opacity="0.95">
            <circle cx="121" cy="220" r="10" />
            <path d="M121 210 v-10" />
          </g>
        `;
      }
      // cap
      return `
        <g>
          <path d="M120 160 C130 120 160 98 200 98 C250 98 280 130 282 162 C255 140 230 130 200 130 C170 130 145 140 120 160 Z" fill="#0B1020" opacity="0.85"/>
          <path d="M125 162 C155 144 178 138 200 138 C228 138 252 146 275 162" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="8" stroke-linecap="round"/>
          <path d="M240 130 C280 132 305 148 310 170 C280 168 260 162 240 156 Z" fill="#0B1020" opacity="0.85"/>
        </g>
      `;
    }

    function layerNameplate(model){
      const name = (model.displayName || 'Player').slice(0,18);
      const badge = model.badge || 'common';
      const badgeColor = badge === 'epic' ? '#7C5CFF' : (badge === 'rare' ? '#20D48A' : '#A9B4DF');
      const badgeText = badge.toUpperCase();

      return `
        <g aria-label="Nameplate">
          <rect x="70" y="338" width="260" height="44" rx="16" fill="rgba(0,0,0,.35)" stroke="rgba(255,255,255,.10)" />
          <rect x="82" y="350" width="76" height="20" rx="999" fill="${badgeColor}" opacity="0.95" />
          <text x="120" y="365" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-size="10" fill="#0B1020" style="font-weight:800; letter-spacing:.6px">${badgeText}</text>
          <text x="206" y="368" text-anchor="middle" font-family="ui-sans-serif, system-ui" font-size="14" fill="#E8EEFF" style="font-weight:750">${escapeXML(name)}</text>
        </g>
      `;
    }

    // (8) Animation: blink + breathe are handled by CSS inside the SVG.
    function svgStyle(model){
      if(!model.animate) return '';
      // Blink + breathe + tiny float. We keep it subtle so it reads as "premium" not "cartoonish".
      return `
        <style>
          @keyframes blink {
            0%, 92%, 100% { opacity: 0; }
            93%, 95% { opacity: 1; }
          }
          @keyframes blinkOpen {
            0%, 92%, 100% { opacity: 1; }
            93%, 95% { opacity: 0; }
          }
          @keyframes breathe {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(1px) scale(1.018); }
          }
          @keyframes floaty {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-1.5px); }
          }
          #breathe { transform-origin: 200px 260px; animation: breathe 3.4s ease-in-out infinite; }
          #floaty { transform-origin: 200px 220px; animation: floaty 6.5s ease-in-out infinite; }
          #eyesClosed { animation: blink 5.3s infinite; }
          #eyesOpen { animation: blinkOpen 5.3s infinite; }
        </style>
      `;
    }

    function renderAvatarSVG(model, hoverTilt=0){
      const tilt = Number(model.tilt || 0) + Number(hoverTilt || 0);

      // (7) Directional light derived from tilt (makes highlights feel responsive)
      const lightAngle = -35 + (hoverTilt * 6); // degrees
      const lightX = 40 + (hoverTilt * 18); // gradient center shift
      const lightY = 28;

      const ground = `<ellipse cx="200" cy="382" rx="110" ry="18" fill="rgba(0,0,0,.25)"/>`;

      // Global defs: materials + grain + rim (7)
      const defs = `
        <defs>
          <!-- Soft shadow -->
          <filter id="softShadow" x="-30%" y="-30%" width="160%" height="160%">
            <feDropShadow dx="0" dy="10" stdDeviation="12" flood-color="rgba(0,0,0,.40)"/>
          </filter>

          <!-- Hair shadow -->
          <filter id="hairShadow" x="-30%" y="-30%" width="160%" height="160%">
            <feDropShadow dx="0" dy="6" stdDeviation="8" flood-color="rgba(0,0,0,.35)"/>
          </filter>

          <!-- Grain (subtle, adds texture) -->
          <filter id="grain" x="-20%" y="-20%" width="140%" height="140%">
            <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch" />
            <feColorMatrix type="matrix" values="
              0 0 0 0 0.8
              0 0 0 0 0.8
              0 0 0 0 0.8
              0 0 0 0.08 0" />
          </filter>

          <!-- Skin light + shade -->
          <radialGradient id="skinLight" cx="${lightX}%" cy="${lightY}%" r="75%">
            <stop offset="0%" stop-color="rgba(255,245,230,.55)" />
            <stop offset="52%" stop-color="rgba(255,255,255,.10)" />
            <stop offset="100%" stop-color="rgba(0,0,0,0)" />
          </radialGradient>
          <radialGradient id="skinShade" cx="${100-lightX}%" cy="${70-lightY}%" r="85%">
            <stop offset="0%" stop-color="rgba(0,0,0,.22)" />
            <stop offset="55%" stop-color="rgba(0,0,0,.10)" />
            <stop offset="100%" stop-color="rgba(0,0,0,0)" />
          </radialGradient>

          <!-- Rim stroke: bright on light side, fades away -->
          <linearGradient id="rimStroke" x1="0" y1="0" x2="1" y2="0" gradientTransform="rotate(${lightAngle} 0.5 0.5)">
            <stop offset="0%" stop-color="rgba(255,255,255,.0)" />
            <stop offset="45%" stop-color="rgba(255,255,255,.16)" />
            <stop offset="65%" stop-color="rgba(255,255,255,.0)" />
          </linearGradient>

          <!-- Hair materials -->
          <linearGradient id="hairShine" x1="0" y1="0" x2="1" y2="1" gradientTransform="rotate(${lightAngle} 0.5 0.5)">
            <stop offset="0%" stop-color="rgba(255,255,255,.0)" />
            <stop offset="40%" stop-color="rgba(255,255,255,.26)" />
            <stop offset="55%" stop-color="rgba(255,255,255,.0)" />
          </linearGradient>
          <radialGradient id="hairShade" cx="50%" cy="30%" r="70%">
            <stop offset="0%" stop-color="rgba(0,0,0,.28)" />
            <stop offset="70%" stop-color="rgba(0,0,0,.0)" />
          </radialGradient>

          <!-- Cloth materials -->
          <linearGradient id="clothLight" x1="0" y1="0" x2="1" y2="1" gradientTransform="rotate(${lightAngle} 0.5 0.5)">
            <stop offset="0%" stop-color="rgba(255,255,255,.0)" />
            <stop offset="35%" stop-color="rgba(255,255,255,.22)" />
            <stop offset="62%" stop-color="rgba(255,255,255,.0)" />
          </linearGradient>
          <radialGradient id="clothShade" cx="${100-lightX}%" cy="75%" r="85%">
            <stop offset="0%" stop-color="rgba(0,0,0,.25)" />
            <stop offset="65%" stop-color="rgba(0,0,0,.0)" />
          </radialGradient>

          <!-- Iris gradient uses currentColor so it adapts to chosen eye color -->
          <radialGradient id="irisGrad" cx="30%" cy="30%" r="70%">
            <stop offset="0%" stop-color="rgba(255,255,255,.65)" />
            <stop offset="55%" stop-color="currentColor" />
            <stop offset="100%" stop-color="rgba(0,0,0,.55)" />
          </radialGradient>
        </defs>
      `;

      // outfit clipPath: we define it each render so it matches the outfit silhouette
      const outfitClip = `
        <defs>
          <clipPath id="outfitClip">
            <path d="${model.outfit === 'tee'
              ? 'M120 292 C145 270 170 260 200 260 C230 260 255 270 280 292 L270 340 C250 358 230 366 200 366 C170 366 150 358 130 340 Z'
              : (model.outfit === 'armor'
                ? 'M128 294 C152 268 174 258 200 258 C226 258 248 268 272 294 L260 346 C236 366 220 372 200 372 C180 372 164 366 140 346 Z'
                : 'M120 294 C140 266 165 252 200 252 C235 252 260 266 280 294 L270 346 C248 366 226 374 200 374 C174 374 152 366 130 346 Z')
            }" />
          </clipPath>
        </defs>
      `;

      // Layer stack (5)
      const layers = [
        layerBackground,
        () => ground,
        // float wrapper
        (m) => `<g id="floaty">` +
          `<g id="breathe">` +
            `<g transform="rotate(${tilt} 200 220)">` +
              layerOutfit(m) +
              layerBody(m) +
              layerHair(m) +
              layerFace(m) +
              layerAccessory(m) +
            `</g>` +
          `</g>` +
        `</g>`,
        layerNameplate,
        // film grain on top
        () => `<rect x="0" y="0" width="400" height="400" filter="url(#grain)" opacity="0.22"/>`,
        // frame
        () => `<rect x="22" y="22" width="356" height="356" rx="26" fill="none" stroke="rgba(255,255,255,.07)" stroke-width="2"/>`,
      ];

      return `
        <svg width="400" height="400" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg" aria-label="Avatar">
          ${svgStyle(model)}
          ${defs}
          ${outfitClip}
          ${layers.map(fn => fn(model)).join('')}
        </svg>
      `;
    }

    // -----------------------------
    // Helpers
    // -----------------------------
    function escapeXML(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&apos;');
    }

    function render(){
      document.getElementById('svgMount').innerHTML = renderAvatarSVG(state, hoverTiltState);
      document.getElementById('jsonOut').textContent = JSON.stringify(state, null, 2);
      document.getElementById('seedLabel').textContent = `Seed: ${state.seed || '—'}`;
    }

    // -----------------------------
    // UI wiring
    // -----------------------------
    const ids = [
      'bodyShape','skin','hairStyle','hair','eyeStyle','eye','mouthStyle','accessory','outfit','outfitColor','bg','tilt','displayName','badge'
    ];

    function syncInputs(){
      for(const id of ids){
        const el = document.getElementById(id);
        if(!el) continue;
        if(el.type === 'range') el.value = String(state[id]);
        else el.value = state[id];
      }
    }

    function bind(){
      for(const id of ids){
        const el = document.getElementById(id);
        el.addEventListener('input', () => {
          state[id] = (el.type === 'range') ? Number(el.value) : el.value;
          if(id !== 'tilt') state.seed = state.seed || 1;
          render();
        });
      }

      document.getElementById('randomBtn').addEventListener('click', randomize);

      document.getElementById('copyBtn').addEventListener('click', async () => {
        try{
          await navigator.clipboard.writeText(JSON.stringify(state, null, 2));
          flashToast('Copied JSON');
        }catch(e){
          flashToast('Copy failed (browser permission)');
        }
      });

      document.getElementById('exportBtn').addEventListener('click', () => exportPNG());

      // (8) Hover tilt: subtle parallax rotation based on mouse position
      const frame = document.querySelector('.avatarFrame');
      frame.addEventListener('mousemove', (e) => {
        const r = frame.getBoundingClientRect();
        const nx = (e.clientX - r.left) / r.width; // 0..1
        hoverTiltState = (nx - 0.5) * 6; // -3..3 degrees
        render();
      });
      frame.addEventListener('mouseleave', () => {
        hoverTiltState = 0;
        render();
      });
    }

    let hoverTiltState = 0;

    function flashToast(text){
      const t = document.createElement('div');
      t.textContent = text;
      Object.assign(t.style, {
        position:'fixed', left:'50%', bottom:'16px', transform:'translateX(-50%)',
        background:'rgba(0,0,0,.55)', color:'white', padding:'10px 12px', borderRadius:'999px',
        border:'1px solid rgba(255,255,255,.12)', backdropFilter:'blur(6px)',
        zIndex:9999, fontSize:'13px', boxShadow:'0 20px 50px rgba(0,0,0,.35)'
      });
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.transition='opacity .25s ease'; t.style.opacity='0'; }, 850);
      setTimeout(()=>{ t.remove(); }, 1200);
    }

    // Export by rasterizing SVG to canvas
    function exportPNG(){
      const svg = document.querySelector('#svgMount svg');
      if(!svg) return;

      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(svg);

      const img = new Image();
      const svgBlob = new Blob([svgString], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(svgBlob);

      img.onload = () => {
        const scale = 2;
        const canvas = document.createElement('canvas');
        canvas.width = 400*scale;
        canvas.height = 400*scale;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        URL.revokeObjectURL(url);

        canvas.toBlob((blob) => {
          if(!blob) return;
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `avatar_${Date.now()}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
          flashToast('Exported PNG');
        }, 'image/png');
      };

      img.onerror = () => {
        URL.revokeObjectURL(url);
        flashToast('Export failed');
      };

      img.src = url;
    }

    function init(){
      syncInputs();
      bind();
      render();
    }

    init();
  </script>
</body>
</html>
